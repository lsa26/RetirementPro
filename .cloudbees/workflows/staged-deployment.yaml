apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow

name: RetirementPro - Staged Deployment

on:
  push:
    branches:
      - master

permissions:
  scm-token-own: read
  id-token: write

jobs:
  build:
    steps:
      - name: Checkout Code
        uses: cloudbees-io/checkout@v1
        
      - name: Trigger Jenkins Build
        uses: cloudbees-io/jenkins-run-job@v2
        with:
          url: https://core.cloudbees.guru/shared-demos
          job-name: lsa/RetirementProFolder/build/master
          parameters: '{}'
          
      - name: Publish Build Evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |
            ## ğŸ—ï¸ Build Jenkins (Kubernetes)
            
            **Application**: RetirementPro
            **Build**: ${{ cloudbees.run_number }}
            **Commit**: ${{ cloudbees.scm.sha }}
            **Branch**: ${{ cloudbees.scm.branch }}
            **Agent**: Kubernetes Pod (Maven 3.9.5 + JDK 17)
            
            âœ… Build completed successfully
            âœ… Artifact: retirement-api-1.0.0-SNAPSHOT.jar
            âœ… Ready for deployment
  
  deploy-dev:
    needs: build
    steps:
      - name: Deploy to DEV
        uses: cloudbees-io/kubectl@v1
        with:
          command: |
            echo "âœ… Deploying RetirementPro to DEV environment"
            echo "ğŸ“ URL: https://retirement-pro-dev.demo.cloudbees.io"
            
      - name: Publish DEV Evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |
            ## ğŸš€ Deployment - DEV Environment
            
            **Environment**: Development
            **URL**: https://retirement-pro-dev.demo.cloudbees.io
            **Build**: ${{ cloudbees.run_number }}
            
            âœ… Deployed successfully
            âœ… Ready for QA validation
