apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow

name: RetirementPro - Build and Test

on:
  push:
    branches:
      - master

permissions:
  scm-token-own: read
  id-token: write

jobs:
  build-jenkins:
    outputs:
      jenkins-output: ${{ steps.jenkins-build.outputs.jenkins_output }}
    steps:
      - name: Checkout
        uses: cloudbees-io/checkout@v1
        
      - name: Build with Jenkins
        id: jenkins-build
        uses: cloudbees-io/jenkins-run-job@v2
        with:
          url: https://core.cloudbees.guru/shared-demos
          job-name: lsa/RetirementProFolder/build/master
          
      - name: Publish Build Evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |
            ## ğŸ—ï¸ Build Jenkins (CloudBees CI)
            
            **Pipeline**: lsa/RetirementProFolder/build/master
            **Jenkins Output**: ${{ steps.jenkins-build.outputs.jenkins_output }}
            **Agent**: Kubernetes Pod (Maven 3.9.5 + JDK 17)
            **Commit**: ${{ cloudbees.scm.sha }}
            **Branch**: ${{ cloudbees.scm.branch }}
            
            âœ… Build completed on CloudBees CI
            âœ… Artifact archived in Jenkins
  
  test-github:
    needs: build-jenkins
    steps:
      - name: Checkout
        uses: cloudbees-io/checkout@v1
        
      - name: Run GitHub Actions Tests
        uses: cloudbees-io/ghactions-run-workflow@v2
        with:
          workflow-file-name: tests.yml
          branch-name: master
          org-name: lsa26
          
      - name: Publish Test Evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |
            ## ğŸ§ª Tests (GitHub Actions)
            
            **Workflow**: tests.yml
            **Tests**: JUnit unit tests
            **Jenkins Output**: ${{ needs.build-jenkins.outputs.jenkins-output }}
            
            âœ… Tests executed on GitHub Actions
            âœ… Results available in CloudBees Platform
            âœ… Orchestration: Jenkins Build â†’ GitHub Tests
